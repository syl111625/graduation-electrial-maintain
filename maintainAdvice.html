<!DOCTYPE html>
<html>

	<head>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">
		
		<link href="css/animate.css" rel="stylesheet">
		<link href="css/style.css?v=4.1.0" rel="stylesheet">
		<link href="css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
		<link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
		<style type="text/css">
			.feckback{
				text-align: center;
				color:blue;
				margin-top: -5px;
				padding-bottom: 10px;
			}
			
			.getList{
				margin: 10px 0 0 15px;				
			}
			table{
				background: #FFFFFF;
				margin-right: 10px;
				
			}
			.table-container
{
width: 100%;
overflow-y: auto;
_overflow: auto;
margin: 0 0 1em;
}
table{border:0; border-collapse:collapse;}
table td,table th{border:1px solid #999; padding:.5em 1em}
//添加IOS下滚动条
.table-container::-webkit-scrollbar
{
-webkit-appearance: none;
width: 14px;
height: 14px;
}

.table-container::-webkit-scrollbar-thumb
{
border-radius: 8px;
border: 3px solid #fff;
background-color: rgba(0, 0, 0, .3);
}
		</style>
		<title>维修反馈</title>
	</head>
	<!--消息管理/发布消息-->

	<body class="gray-bg">
		<div class="wrapper wrapper-content">
			<h2 class="feckback">欢迎反馈意见</h2>
			
			
			<ul class="nav nav-tabs" role="tablist" id="equipTabs">
					<li role="presentation" class="active">
						<a href="#home" aria-controls="home" role="tab" data-toggle="tab">维修反馈</a>
					</li>
					<li role="presentation">
						<a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">维修列表</a>
					</li>

			</ul>
				
				<div class="tab-content">
					<!--节能策略1-->
					<div role="tabpanel" class="tab-pane active" id="home">
						<div class="row">

				<div class="col-sm-12">
					<div class="ibox">
						<div class="ibox-content mailbox-content">
							<!--<p class="control-label h4 m-b-md">维修反馈</p>-->

							<form id="adviceForm" class="form-horizontal">
								<div class="form-group">
									<label class="col-sm-2 control-label">姓名：</label>
									<div class="col-sm-10">
										<input id="maintenanceMan" name="maintenanceMan" type="hidden" placeholder="请输入您的姓名" class="form-control">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">设备号：</label>
									<div class="col-sm-10">
										<input id="deviceId" name="deviceId" type="text" placeholder="请输入您维修的设备号" class="form-control">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">维修原因：</label>
									<div class="col-sm-10">
										<textarea id="msg" name="msg" class="form-control"  wrap="virtual" placeholder="请简述您的维修任务"></textarea>
									</div>
								</div>
								
								<!--<div class="form-group">
									<label class="col-sm-2 control-label">手机号：</label>
									<div class="col-sm-10">
										<input id="phone" name="phone" type="hidden" placeholder="请输入您的手机号" class="form-control">
									</div>
								</div>-->
								<div class="form-group">
									
									<label class="col-sm-2 control-label">反馈：</label>
									<div class="col-sm-10">
										<textarea id="feedback" name="feedback" class="form-control" name="marks" wrap="virtual" placeholder="其他建议"></textarea>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">反馈时间：</label>
									<div class="col-sm-10">
										<input id="time" name="time" type="date" class="form-control " >
									</div>
								</div>
								
								

								<div class="row form-group">
									<!--<div class="col-sm-2">
								<button class="btn btn-primary full-width table-bordered" type="button">保存计划</button>
							</div>-->
									<div class="col-sm-2 col-sm-offset-2">
										<button id="sendAdvice" class="btn btn-info full-width" type="button">立即反馈</button>
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
					</div>
					</div>
					
					<div role="tabpanel" class="tab-pane" id="profile">
						
						<!--<div class="row">
					<div class="col-xs-12">-->
		
					<!--<div class="ibox-title">
						<h5>用户列表</h5>
						<a href="userAdd.html" class="btn btn-info adduser">添加 </a>
					</div>-->

					<div class="ibox-content table-container">

						<!--<table class="table table-striped table-bordered table-hover" id="task_query">
							<thead class="col-xs-12 mainTainList">
									<tr>

										<th class="col-xs-2">id</th>
										<th class="col-xs-2">设备id</th>
										<th class="col-xs-2">维修人</th>
										<th class="col-xs-2">故障描述</th>
										<th class="col-xs-1">手机号</th>
										<th class="col-xs-2">反馈</th>
										<th class="col-xs-1">时间</th>
									</tr>
								</thead>
								<tbody class="col-xs-12" id="adviceList">
									<tr>
										<td class="col-xs-2">1</td>
										<td class="col-xs-2">2</td>
										<td class="col-xs-2">li</td>
										<td class="col-xs-2">li</td>
										<td class="col-xs-2">666666</td>
										<td class="col-xs-2">888</td>
										<td class="col-xs-2">2017-10-8</td>
									</tr>
									
								</tbody>
						</table>-->
						
						
						<table class="table table-striped table-bordered table-hover">
								<thead >
									<tr >

										<th >id</th>
										<th >设备id</th>
										<th >维修人</th>
										<th >故障描述</th>
										<th >手机号</th>
										<th >反馈</th>
										<th >时间</th>
									</tr>
								</thead>
								<tbody  id="adviceList">
									<tr >
										<td >1</td>
										<td >2</td>
										<td >li</td>
										<td >设备2电压过低</td>
										<td >18813719786</td>
										<td >已修好，很满意通知方式</td>
										<td >2017-11-14</td>
									</tr>
									
								</tbody>
								
							</table>
					</div>
				</div>
			</div>
							
							
						
					</div>
				</div>
					</div>

		</div>
					</div>
			

				

				<!-- 全局js -->
				<script src="js/jquery.min.js"></script>
				<script src="js/bootstrap.min.js"></script>
				
				<script src="js/plugins/dataTables/jquery.dataTables.js"></script>
				<script src="js/plugins/dataTables/dataTables.bootstrap.js"></script>
				<script src="js/plugins/sweetalert/sweetalert.min.js"></script>
				<script src="js/url.js" type="text/javascript"></script>
				<script>
					var oTable1 = $('#task_query').dataTable();
				</script>
			<script type="text/javascript">		
					//		切换视图
			$('#equipTabs a').click(function(e) {
				e.preventDefault();
				$(this).tab('show');
			});
			
//					var url="http://192.168.3.7:8080/";
					
					//提交维修反馈表单
					$("#sendAdvice").click(function(){
//						
						
						//jQuery.support.cors = true;
					$.ajax({
						url:url+ "maintenance/updateMaintenanceRecord",
						type: 'post',
						data: $("#adviceForm").serialize(),
						dataType: "json",
						xhrFields: {
							withCredentials: true
						},
						crossDomain: true,
						success: function(data) {
							console.log(data);
							swal({
								title: "反馈成功！",
								type: "success",
								showCancelButton: false,
								confirmButtonColor: "#44BB44",
								confirmButtonText: "确定",
								closeOnConfirm: true,
							});
							$('#home').removeClass("active");
							$('#profile').addClass("active");
						},
						error: function() {
							alert('error');
						}
					});
					});
					
				
				
				
//				var wsUrl="ws://192.168.3.7:8080/webSocketServer/";
			var storage = window.localStorage;	
			var id = storage.getItem("id");
			console.log("连接id"+id);
				//	websocket前台页面方法
			var websocket = null;

			//  判断当前浏览器是否支持WebSocket
			if('WebSocket' in window) {
				//    	申请一个WebSocket对象，参数是需要连接的服务器端的地址 
				websocket = new WebSocket(wsUrl+id);

			} else {
				alert('Not support websocket');
			}

			//  如果连接失败，发送、接收数据失败或者处理数据出现错误，浏览器会触发onerror消息;
			websocket.onerror = function() {
				console.log("back/index.js, websocket握手失败");
			};

			websocket.onopen = function(event) {};

			  
			
			if(websocket.readyState == 1) {
				websocket.send('hello world');
			}

			//  传递消息的渠道
			websocket.onmessage = function(event) {
				//      setMessageInnerHTML(event.data);
				console.log(event.data);
				var data=event.data;
				var maintenance=data.split("|");
				$("#deviceId").val(maintenance[0]);
				$("#maintenanceMan").val(maintenance[1]);
				var storage = window.localStorage;	
				storage.setItem("maintenanceName",maintenance[1]);
				$("#msg").val(maintenance[2].split("，")[0]);
				
				
			};

			

			//  连接关闭的回调方法
			websocket.onclose = function() {};

			//  当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
			window.onbeforeunload = function() {
				websocket.close();
			};
			
			
			
			//获取维修列表
				//存储维修人名字
				var storage = window.localStorage;	
				var maintenanceP = storage.getItem("maintenanceP");
				var maintenancePe=maintenanceP.split("-");
				console.log(maintenancePe[0]);
				var maintenanceManName=maintenancePe[0];
			$.ajax({
//				url: url + "maintenance/records?maintenanceManName="+maintenanceMan,
				url: url + "maintenance/records",
				type: 'get',
				data:{maintenanceManName:maintenanceManName},
				dataType: "json",
				xhrFields: {
					withCredentials: true
				},
				crossDomain: true,
				success: function(data) {
					console.log(data);
					var str = "";
					
					for(i in data) {
						
						str += "<tr>" +
							"<td >" + data[i].id + "</td>" +
							"<td >" + data[i].deviceId + "</td>" +
							"<td >" + data[i].maintenanceMan + "</td>" +
							"<td >" + data[i].phone + "</td>" +
							"<td >" + data[i].msg + "</td>" +
							
							"<td >" + data[i].feedback + "</td>" +
							"<td >" + data[i].time + "</td>" +
							"</tr>";

					}
					$("#adviceList").html(str);
				},
				error: function() {
								console.log('error');
								
							}
				});
				
				</script>
	</body>

</html>